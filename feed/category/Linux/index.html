<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
xmlns:content="http://purl.org/rss/1.0/modules/content/"
xmlns:dc="http://purl.org/dc/elements/1.1/"
xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
xmlns:atom="http://www.w3.org/2005/Atom"
xmlns:wfw="http://wellformedweb.org/CommentAPI/">
<channel>
<title>Marco Nie - Linux</title>
<link>https://blog.niekun.net/category/Linux/</link>
<atom:link href="https://blog.niekun.net/feed/category/Linux/" rel="self" type="application/rss+xml" />
<language>zh-CN</language>
<description></description>
<lastBuildDate>Fri, 22 Jan 2021 11:16:00 +0800</lastBuildDate>
<pubDate>Fri, 22 Jan 2021 11:16:00 +0800</pubDate>
<item>
<title>服务器部署 WebDAV 服务</title>
<link>https://blog.niekun.net/archives/2074.html</link>
<guid>https://blog.niekun.net/archives/2074.html</guid>
<pubDate>Fri, 22 Jan 2021 11:16:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[WebDAV(Web-based Distributed Authoring and Versioning) 一种基于 HTTP 1.1协议的通信协议。它扩展了HTTP 1.1在 GET、POS...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>WebDAV(Web-based Distributed Authoring and Versioning) 一种基于 HTTP 1.1协议的通信协议。它扩展了HTTP 1.1在 <strong>GET</strong>、<strong>POST</strong>、<strong>HEAD</strong>等几个HTTP标准方法以外添加了一些新的方法，使应用程序可对Web Server直接读写，并支持写文件锁定(Locking)及解锁(Unlock)，还可以支持文件的版本控制。</p><p>简单说 webdav 就像一个网盘，可以远程访问他的目录名对其文件进行读写操作。</p><p><strong>WebDAV 允许客户端进行下列操作：</strong></p><ul><li>处理服务器上 WebDAV 发布目录中的资源</li><li>具有正确权限的用户可以在 WebDAV目录中复制和移动文件</li><li>修改与某些资源相关联的属性。例如，用户可写入并检索文件的属性信息</li><li>锁定并解锁资源以便多个用户可同时读取一个文件。但每次只能有一个人修改文件</li><li>搜索 WebDAV 目录中的文件的内容和属性</li></ul><!--more--><p>下面介绍如何在服务器上部署 WebDAV 服务。这里通过 nginx 来代理。</p><h3>编译 nginx</h3><p>我们通过 nginx 来代理 webdav 服务，nginx 自带有 ngx_http_dav_module 模块，但是其不支持一些 webdav 的 method 如：PROPFIND, OPTIONS, LOCK, UNLOCK。可以通过第三方模块来完整支持 webdav 的特性。</p><p>下载以下两个第三方模块：<br><strong>nginx-dav-ext-module</strong>：<a href="https://github.com/arut/nginx-dav-ext-module">https://github.com/arut/nginx-dav-ext-module</a><br><strong>headers-more-nginx-module</strong>：<a href="https://github.com/openresty/headers-more-nginx-module">https://github.com/openresty/headers-more-nginx-module</a></p><p>以上两个模块需要在编译时通过 <strong>--add-module</strong> 参数来引入模块，同时需要包含 <strong>--with-http_dav_module</strong> 模块，否则编译会报错。</p><p>从源码编译 nginx 参考我之前的教程：<a href="https://blog.niekun.net/archives/30.html">https://blog.niekun.net/archives/30.html</a></p><p>我使用的完整的编译参数如下：</p><pre><code>./configure --prefix=/opt/nginx-1.19.6 \
--user=nginx --group=nginx \
--with-compat --with-file-aio --with-threads \
--with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module \
--with-mail --with-mail_ssl_module \
--with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module \
--add-module=../echo-nginx-module \
--add-module=../ngx-fancyindex \
--add-module=../headers-more-nginx-module \
--add-module=../nginx-dav-ext-module</code></pre><h3>配置文件</h3><p>nginx 编译安装完成后，需要配置 conf 文件来使 webdav 生效。我提前已经设置了一个单独的子域名来访问 webdav 服务，且使用 ssl 加密。</p><p>首先建立 webdav 文件夹并设置正确的权限，否则在读写时会提示权限不足：</p><pre><code>mkdir /home/www/webdav
chown -R www-data:www-data /home/www/webdav</code></pre><p>如果想要限制用户访问，可以使用 <strong>ngx_http_auth_basic_module</strong> 模块来建立账号访问，具体参考：<a href="https://blog.niekun.net/archives/730.html">https://blog.niekun.net/archives/730.html</a></p><p>完整配置文件如下：</p><pre><code>dav_ext_lock_zone zone=foo:10m;
server {
    listen        443 ssl http2;
    listen        [::]:443 ssl http2;
    server_name   webdav.xxx.xxx;
    include       my-server/ssl;

    # 限制访问
    auth_basic           &quot;Restricted Access&quot;;
    auth_basic_user_file ../users/.adminpasswd;

    # webdav 目录
    root /home/www/webdav;
    client_body_temp_path /opt/nginx/client_body_temp;

    # webdav 设置
    dav_access      user:rw  group:rw  all:r;
    dav_methods PUT DELETE MKCOL COPY MOVE;
    dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;
    dav_ext_lock zone=foo;
    create_full_put_path on;

    # 优化大文件上传
    send_timeout 3600;
    client_body_timeout 3600;
    keepalive_timeout 3600;
    lingering_timeout 3600;
    client_max_body_size 2G;

    location / {
        # 创建文件夹操作时结尾添加斜杠
        if ($request_method = MKCOL) {
            rewrite ^(.*[^/])$ $1/ break;
        }

        # 移动文件夹操作时结尾添加斜杠
        if (-d $request_filename) {
            rewrite ^(.*[^/])$ $1/;
            set $md /;
        }

        set $x $http_destination$request_method;
        if ($x ~ [^/]MOVE) {
            more_set_input_headers -r &quot;Destination: ${http_destination}${md}&quot;;
        }
    }

    # 拒绝 Windows 或 macos 多余文件上传到 webdav 路径
    location ~ \.(_.*|DS_Store|Spotlight-V100|TemporaryItems|Trashes|hidden|localized)$ {
        access_log  off;
        error_log   off;

        if ($request_method = PUT) {
            return 403;
        }
        return 404;
    }

    location ~ \.metadata_never_index$ {
        return 200 &quot;Don't index this drive, Finder!&quot;;
    }
}</code></pre><p>注意第一句 <strong>dav_ext_lock_zone</strong> 要放在 http 块内。否则会报错。</p><p>配置文件修改好后，使用下面指令测试配置是否正确：</p><pre><code>nginx -t
</code></pre><p>如果返回 ok 重启服务即可：</p><pre><code>systemctl restart nginx
</code></pre><h3>客户端连接</h3><p>nginx 配置好 webdav 模块并启动后，可以尝试在客户端访问。</p><p>Windows 的 file explorer 和 macos 的 finder 都可以直接连接 webdav。</p><h3>Windows 端</h3><p>在 file explorer 中点击 home - easy access - map as drive：<br><img src="https://blog.niekun.net/usr/uploads/2021/01/797689005.jpg" alt="1.jpg" title="1.jpg"></p><p>在弹出窗口中点击 connect to a web site：<br><img src="https://blog.niekun.net/usr/uploads/2021/01/1204074620.jpg" alt="2.jpg" title="2.jpg"></p><p>点击 next 在地址栏输入服务器 nginx 定义的 webdav 访问地址：<br><img src="https://blog.niekun.net/usr/uploads/2021/01/3507948553.jpg" alt="3.jpg" title="3.jpg"></p><p>点击 next 后如果设置了 <strong>auth_basic</strong> 会提示要求输入账户和密码，输入账户密码后就进入了 webdav 目录了，下面就可以测试新建文件，修改文件等操作。</p><p><strong>注意 Windows 中默认只有 https 方式访问的地址才可以设置 auth，否则不会弹出输入账户和密码的提示框，而是直接提示无法访问此地址。</strong>如果想要开放 http 方式的 auth 验证，需要修改注册表 <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\WebClient\Parameters\BasicAuthLevel</code> 的值为 2，然后重启系统即可，此键值定义为：</p><ul><li>0 - Basic authentication disabled</li><li>1 - Basic authentication enabled for SSL shares only</li><li>2 or greater - Basic authentication enabled for SSL shares and for non-SSL shares</li></ul><h3>macos 端</h3><h3>参考链接：</h3><p><a href="https://www.robpeck.com/2020/06/making-webdav-actually-work-on-nginx/">Making Native WebDAV Actually Work on nginx with Finder and Explorer</a><br><a href="https://www.codetd.com/en/article/9724623">Nginx repair of WebDAV functionality</a><br><a href="http://nginx.org/en/docs/http/ngx_http_dav_module.html">Module ngx_http_dav_module</a><br><a href="https://www.webdavsystem.com/server/prev/v2/documentation/authentication/basic_auth_vista/">Using Basic Authentication with Windows 7 and Windows Vista WebDAV Client</a></p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/2074.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/2074.html</wfw:commentRss>
</item>
<item>
<title>修复 ubuntu vmware 虚拟机无法访问主机共享目录</title>
<link>https://blog.niekun.net/archives/2071.html</link>
<guid>https://blog.niekun.net/archives/2071.html</guid>
<pubDate>Fri, 15 Jan 2021 16:32:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[今天发现在 Ubuntu 20.04 虚拟机内无法访问设置的共享文件夹，在 /mnt/hgfs 目录下是空的，检查虚拟机设置并没有什么问题。最后发现是虚拟机没有自动挂载共享目录，命令行下进行挂载...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>今天发现在 Ubuntu 20.04 虚拟机内无法访问设置的共享文件夹，在 <code>/mnt/hgfs</code> 目录下是空的，检查虚拟机设置并没有什么问题。最后发现是虚拟机没有自动挂载共享目录，命令行下进行挂载即可。</p><p>首先查看当前设置的共享目录有哪些：</p><pre><code>$ vmware-hgfsclient 
Development
Downloads
InstallationPackage</code></pre><p>挂载主机共享路径到虚拟机对应路径下，设置所有用户可访问：</p><pre><code>$ sudo vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other
</code></pre><p>执行以上命令后，发现共享文件夹出现了：</p><pre><code>$ ls /mnt/hgfs/
Development  Downloads  InstallationPackage</code></pre><p>以上就是解决 VMware Linux 虚拟机没有自动挂载共享目录的方法。</p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/2071.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/2071.html</wfw:commentRss>
</item>
<item>
<title>CentOS 6 可用源</title>
<link>https://blog.niekun.net/archives/2035.html</link>
<guid>https://blog.niekun.net/archives/2035.html</guid>
<pubDate>Tue, 29 Dec 2020 13:58:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[最近在调试软件的时候需要用到 CentOS 6 系统，yum 命令无法更新包返回都是 404，查了下发现大多数主流的源地址都取消对 CentOS 6 的支持，找了半天才找到一个可用的地址，记录下...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>最近在调试软件的时候需要用到 CentOS 6 系统，yum 命令无法更新包返回都是 404，查了下发现大多数主流的源地址都取消对 CentOS 6 的支持，找了半天才找到一个可用的地址，记录下来备用。</p><p>CentOS 6 的包列表在：<code>/etc/yum.repos.d/CentOS-Base.repo</code> 文件中定义。</p><p>参考链接：<a href="https://blog.csdn.net/h952520296/article/details/110541018">https://blog.csdn.net/h952520296/article/details/110541018</a></p><pre><code># CentOS-Base.repo
#
# The mirror system uses the connecting IP address of the client and the
# update status of each mirror to pick mirrors that are updated to and
# geographically close to the client.  You should use this for CentOS updates
# unless you are manually picking other mirrors.
#
# If the mirrorlist= does not work for you, as a fall back you can try the 
# remarked out baseurl= line instead.
#
#
 
[base]
name=CentOS-6.10 - Base - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos-vault/6.10/os/$basearch/
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6
 
#released updates 
[updates]
name=CentOS-6.10 - Updates - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos-vault/6.10/updates/$basearch/
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6
 
#additional packages that may be useful
[extras]
name=CentOS-6.10 - Extras - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos-vault/6.10/extras/$basearch/
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6
 
#additional packages that extend functionality of existing packages
[centosplus]
name=CentOS-6.10 - Plus - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos-vault/6.10/centosplus/$basearch/
gpgcheck=1
enabled=0
gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6
 
#contrib - packages by Centos Users
[contrib]
name=CentOS-6.10 - Contrib - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos-vault/6.10/contrib/$basearch/
gpgcheck=1
enabled=0
gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6</code></pre><p>将以上内容替换到 <code>CentOS-Base.repo</code> 文件内，然后执行：</p><pre><code>yum clean all &amp;&amp; yum makecache
</code></pre><p>更新缓存即可。</p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/2035.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/2035.html</wfw:commentRss>
</item>
<item>
<title>Speedtest CLI 命令行测速工具</title>
<link>https://blog.niekun.net/archives/1911.html</link>
<guid>https://blog.niekun.net/archives/1911.html</guid>
<pubDate>Mon, 16 Nov 2020 13:08:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[speedtest 是国外很流行的测速平台，可以直接在其网站上测试本地上行下行带宽，最近看到其提供了本地命令行工具，使用起来更加方便了。官网：https://www.speedtest.net/]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>speedtest 是国外很流行的测速平台，可以直接在其网站上测试本地上行下行带宽，最近看到其提供了本地命令行工具，使用起来更加方便了。</p><p>官网：<a href="https://www.speedtest.net/">https://www.speedtest.net/</a></p><!--more--><h3>安装</h3><p>首先需要到官网安装对应平台的 CLI 工具：<a href="https://www.speedtest.net/apps/cli">https://www.speedtest.net/apps/cli</a></p><p>Linux 类系统可以直接在使用 apt/brew 等包管理工具方便的安装，Windows 下需要手动下载 exe 可执行文件使用。</p><p><strong>macOS:</strong></p><pre><code>brew tap teamookla/speedtest
brew update
brew install speedtest --force</code></pre><p><strong>ubuntu:</strong></p><pre><code>sudo apt-get install gnupg1 apt-transport-https dirmngr
export INSTALL_KEY=379CE192D401AB61
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys $INSTALL_KEY
echo &quot;deb https://ookla.bintray.com/debian generic main&quot; | sudo tee  /etc/apt/sources.list.d/speedtest.list
sudo apt-get update
sudo apt-get install speedtest</code></pre><p><strong>windows:</strong><br>首先在网站上下载可执行文件，<a href="https://bintray.com/ookla/download/download_file?file_path=ookla-speedtest-1.0.0-win64.zip">点击下载 1.0.0 版</a>。</p><p>可执行文件为 <code>speedtest.exe</code>，需要将其目录加入系统 PATH 路径才可以直接在 terminal 调用，加入 PATH 方法参考我的教程：<a href="https://blog.niekun.net/archives/413.html">https://blog.niekun.net/archives/413.html</a></p><h3>使用</h3><p>在终端下使用 <code>speedtest -h</code> 命令查看帮助：</p><pre><code>Speedtest by Ookla is the official command line client for testing the speed and performance of your internet connection.

Version: speedtest 1.0.0.2

Usage: speedtest [&lt;options&gt;]
  -h, --help                        Print usage information
  -V, --version                     Print version number
  -L, --servers                     List nearest servers
  -s, --server-id=#                 Specify a server from the server list using its id
  -I, --interface=ARG               Attempt to bind to the specified interface when connecting to servers
  -i, --ip=ARG                      Attempt to bind to the specified IP address when connecting to servers
  -o, --host=ARG                    Specify a server, from the server list, using its host's fully qualified domain name
  -p, --progress=yes|no             Enable or disable progress bar (Note: only available for 'human-readable'
                                    or 'json' and defaults to yes when interactive)
  -P, --precision=#                 Number of decimals to use (0-8, default=2)
  -f, --format=ARG                  Output format (see below for valid formats)
  -u, --unit[=ARG]                  Output unit for displaying speeds (Note: this is only applicable
                                    for ‘human-readable’ output format and the default unit is Mbps)
  -a                                Shortcut for [-u auto-decimal-bits]
  -A                                Shortcut for [-u auto-decimal-bytes]
  -b                                Shortcut for [-u auto-binary-bits]
  -B                                Shortcut for [-u auto-binary-bytes]
      --selection-details           Show server selection details
      --ca-certificate=ARG          CA Certificate bundle path
  -v                                Logging verbosity. Specify multiple times for higher verbosity
      --output-header               Show output header for CSV and TSV formats

 Valid output formats: human-readable (default), csv, tsv, json, jsonl, json-pretty

 Machine readable formats (csv, tsv, json, jsonl, json-pretty) use bytes as the unit of measure with max precision

 Valid units for [-u] flag:
   Decimal prefix, bits per second:  bps, kbps, Mbps, Gbps
   Decimal prefix, bytes per second: B/s, kB/s, MB/s, GB/s
   Binary prefix, bits per second:   kibps, Mibps, Gibps
   Binary prefix, bytes per second:  kiB/s, MiB/s, GiB/s
   Auto-scaled prefix: auto-binary-bits, auto-binary-bytes, auto-decimal-bits, auto-decimal-bytes</code></pre><p>首先使用测试最近的测速节点 <code>testspeed -L</code>:</p><pre><code>root@Marco-vostro-14-wsl:~# speedtest -L
Closest servers:

    ID  Name                           Location             Country
==============================================================================
 29105  陕西移动5G                 Xi'an                China
  2461  China Unicom                   Chengdu              China
  4575  China Mobile Group Sichuan     Chengdu              China
 24337  China Mobile Group Sichuan Co.,Ltd. Chengdu              China
 35527  sccn                           Chengdu              China
 31985  China Unicom                   Chongqing            China
 17584  Chongqing Mobile Company       Chongqing            CN
  5530  CCN                            Chongqing            China
 16145  Lanzhou,China Mobile,Gansu     Lanzhou              China</code></pre><p>执行 <code>speedtest</code> 命令进行测速，默认使用上面测试的最近的节点：</p><pre><code>root@Marco-vostro-14-wsl:~# speedtest

   Speedtest by Ookla

     Server: Chongqing Mobile Company - Chongqing (id = 17584)
        ISP: China Telecom
    Latency:    31.45 ms   (25.47 ms jitter)
   Download:    14.31 Mbps (data used: 17.5 MB)
     Upload:     8.23 Mbps (data used: 11.3 MB)
Packet Loss:     0.0%
 Result URL: https://www.speedtest.net/result/c/bee17d45-7b9c-44e6-8a6e-ef99d84ba441</code></pre><p>以上就是简单的用法，可以查看帮助了解更多的使用方法。</p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/1911.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/1911.html</wfw:commentRss>
</item>
<item>
<title>两个子网间网络互访的原理</title>
<link>https://blog.niekun.net/archives/1906.html</link>
<guid>https://blog.niekun.net/archives/1906.html</guid>
<pubDate>Fri, 13 Nov 2020 11:29:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[之前我介绍过子网，子网掩码，网关等基本概念解析，可以参考：https://blog.niekun.net/archives/1885.html在不同子网下的设备是不能直接访问的，因为他们在不同的...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>之前我介绍过子网，子网掩码，网关等基本概念解析，可以参考：<a href="https://blog.niekun.net/archives/1885.html">https://blog.niekun.net/archives/1885.html</a></p><p>在不同子网下的设备是不能直接访问的，因为他们在不同的网段内，比如：</p><p><img src="https://blog.niekun.net/usr/uploads/2020/11/246904444.gif" alt="FbdOD.gif" title="FbdOD.gif"></p><ul><li>路由 A 下有子网 192.168.1.0/24</li><li>路由 B 下有子网 192.168.3.0/24</li><li>设备 james：192.168.1.10/24 网关：192.168.1.1</li><li>设备 Johnny：192.168.3.10/24 网关：192.168.3.1</li><li>两个路由的 wan 网口在同一网段：192.168.2.0/24 下</li></ul><!--more--><p>正常情况下路由 A 下的设备无法访问路由 B 下的设备，因为他们在不同的子网网段下。</p><p>路由 A 有两个网段：192.168.1.0 和 192.168.2.0，所以它可以同时看见这两个网段的设备，但是它并不知道 192.168.3.0 这一网段的存在。同样的道理，路由 B 并不知道 192.168.1.0 这一网段的存在。</p><p>当你给一个设备添加一个路由表 route table，就可以告诉它有其他网段可以进行访问，同时需要告诉它一个可以访问到这个新网段的网关，这样就可以访问到其他网段了。</p><p>例如让路由 A 访问到路由 B 的子网 192.168.3.0 可以通过给路由 A 添加新的路由表来实现，使用 ip route 命令：</p><pre><code>ip route add 192.168.3.0/24 via 192.168.2.2</code></pre><p>以上命令的意义是添加路由 B 子网的路由表 192.168.3.0/24，网关地址是路由 B 的 wan 地址 192.168.2.2。</p><p>因为路由 B 可以访问到两个网络 192.168.2.0 和 192.168.3.0，而路由 A 和路由 B 通过 192.168.2.0 互访，所以通过给路由 A 添加以上路由表然后网关地址为路由 B 和外部通信的地址，这样路由 A 就可以访问到路由 B 的子网了。</p><p>现在路由 A 可以访问到路由 B 的子网了，那么路由 A 下的设备如何访问路由 B 的子网设备呢？原理是相同的，可以通过给设备添加路由 B 子网的路由表，然后由于路由 A 已经可以访问 路由 B 子网了，所以将网关地址设置为路由 A 地址即可：</p><pre><code>ip route add 192.168.3.0/24 via 192.168.1.1</code></pre><p>在路由 A 下的 James 执行以上命令后，就可以访问到路由 B 下的 Johnny 了。</p><p>同样的原理，在路由 B 上设置路由表及网关就可以实现子网互访了。</p><p>参考链接：<br><a href="https://serverfault.com/questions/171551/help-me-understand-the-ip-route-command-for-cisco-routers">understand the 'ip route' command for cisco routers</a></p>
]]></content:encoded>
<slash:comments>1</slash:comments>
<comments>https://blog.niekun.net/archives/1906.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/1906.html</wfw:commentRss>
</item>
<item>
<title>nextcloud 安装教程</title>
<link>https://blog.niekun.net/archives/1904.html</link>
<guid>https://blog.niekun.net/archives/1904.html</guid>
<pubDate>Wed, 11 Nov 2020 10:42:14 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[安装包：https://nextcloud.com/changelog/#latest20系统需求：https://docs.nextcloud.com/server/20/admin_manu...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>安装包：<a href="https://nextcloud.com/changelog/#latest20">https://nextcloud.com/changelog/#latest20</a><br>系统需求：<a href="https://docs.nextcloud.com/server/20/admin_manual/installation/system_requirements.html">https://docs.nextcloud.com/server/20/admin_manual/installation/system_requirements.html</a><br>nginx 配置：<a href="https://docs.nextcloud.com/server/18/admin_manual/installation/nginx.html">https://docs.nextcloud.com/server/18/admin_manual/installation/nginx.html</a><br>php 配置相关：<a href="https://docs.nextcloud.com/server/20/admin_manual/installation/source_installation.html#php-fpm-tips-label">https://docs.nextcloud.com/server/20/admin_manual/installation/source_installation.html#php-fpm-tips-label</a><br>修改 php 内存限制：<a href="https://www.chinaz.com/program/2011/1010/213048.shtml">https://www.chinaz.com/program/2011/1010/213048.shtml</a><br>安装 php 内存缓存：<a href="https://docs.nextcloud.com/server/15/admin_manual/configuration_server/caching_configuration.html">https://docs.nextcloud.com/server/15/admin_manual/configuration_server/caching_configuration.html</a><br>命令行安装：<a href="https://docs.nextcloud.com/server/stable/admin_manual/installation/command_line_installation.html">https://docs.nextcloud.com/server/stable/admin_manual/installation/command_line_installation.html</a></p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/1904.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/1904.html</wfw:commentRss>
</item>
<item>
<title>MySQL 用户密码规则配置</title>
<link>https://blog.niekun.net/archives/1903.html</link>
<guid>https://blog.niekun.net/archives/1903.html</guid>
<pubDate>Wed, 11 Nov 2020 10:37:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[在创建 MySQL 用户时需要设置密码，有时候输入输入密码后会提示创建失败，密码设置 policy 错误。这是因为当前设置的密码和 MySQL 密码创建规则不符，可以查看当前规定的密码规则也可以...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>在创建 MySQL 用户时需要设置密码，有时候输入输入密码后会提示创建失败，密码设置 policy 错误。这是因为当前设置的密码和 MySQL 密码创建规则不符，可以查看当前规定的密码规则也可以进行修改。</p><p>进入 MySQL 执行下面命令：</p><pre><code>SHOW VARIABLES LIKE 'validate_password%';
</code></pre><p>会列出密码创建相关参数：</p><pre><code>mysql&gt; SHOW VARIABLES LIKE 'validate_password%';
+--------------------------------------+--------+
| Variable_name                        | Value  |
+--------------------------------------+--------+
| validate_password_check_user_name    | ON     |
| validate_password_dictionary_file    |        |
| validate_password_length             | 8      |
| validate_password_mixed_case_count   | 1      |
| validate_password_number_count       | 1      |
| validate_password_policy             | MEDIUM |
| validate_password_special_char_count | 1      |
+--------------------------------------+--------+
7 rows in set (0.03 sec)</code></pre><p>其中 <code>validate_password_length</code> 是密码位数，<code>validate_password_special_char_count</code> 是密码包含特殊字符。可以通过命令修改参数值来改变密码规则，例如：</p><p>取消特殊字符：</p><pre><code>SET GLOBAL validate_password_special_char_count= 0;
</code></pre><p>修改后可以测试再次建立用户设置密码。</p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/1903.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/1903.html</wfw:commentRss>
</item>
<item>
<title>MySQL 8.0 修改用户密码加密方式</title>
<link>https://blog.niekun.net/archives/1900.html</link>
<guid>https://blog.niekun.net/archives/1900.html</guid>
<pubDate>Wed, 11 Nov 2020 09:41:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[MySQL 8.0 默认创建的用户密码加密方式为：caching_sha2_password，有些应用在连接时由于不兼容会导致报错，可以修改为 MySQL 5 使用的加密方式：sha256_pa...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>MySQL 8.0 默认创建的用户密码加密方式为：caching_sha2_password，有些应用在连接时由于不兼容会导致报错，可以修改为 MySQL 5 使用的加密方式：sha256_password。</p><p>创建用户：</p><pre><code>create user &quot;newuser&quot;@&quot;localhost&quot; identified by &quot;PASSWORD&quot;;
</code></pre><p>授予全部数据库权限：</p><pre><code>grant all privileges on *.* to 'newuser'@'localhost';
</code></pre><p>修改成原来的加密方式：</p><pre><code>alter user &quot;newuser&quot;@&quot;localhost&quot; identified with mysql_native_password by 'PASSWORD';
</code></pre><p>刷新权限：</p><pre><code>    FLUSH PRIVILEGES;
</code></pre><p>查看已建立的用户及加密方式：</p><pre><code>SELECT user,authentication_string,plugin,host FROM mysql.user;
</code></pre><p>显示如下：</p><pre><code>+------------------+------------------------------------------------------------------------+---
| user             | authentication_string                         | plugin                | host      |
+------------------+------------------------------------------------------------------------+-----
| marco            | *D51541FCBC8DD8E                              | mysql_native_password | localhost |
| root             |                                               | auth_socket           | localhost |
+------------------+------------------------------------------------------------------------+---------</code></pre><p>以上就是修改用户密码加密方式的方法。</p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/1900.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/1900.html</wfw:commentRss>
</item>
<item>
<title>MySQL 5.7 升级 8.0</title>
<link>https://blog.niekun.net/archives/1899.html</link>
<guid>https://blog.niekun.net/archives/1899.html</guid>
<pubDate>Tue, 10 Nov 2020 11:03:52 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[首先备份本地数据库，以防升级错误：mysqldump -uUSER -pPASSWORD --all-databases &gt; /path/to/backup.sql官网下载最新的 MySQ...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>首先备份本地数据库，以防升级错误：</p><pre><code>mysqldump -uUSER -pPASSWORD --all-databases &gt; /path/to/backup.sql
</code></pre><p>官网下载最新的 MySQL apt 库：<a href="https://dev.mysql.com/downloads/repo/apt/">https://dev.mysql.com/downloads/repo/apt/</a></p><p>当前最新地址为：<a href="https://dev.mysql.com/get/mysql-apt-config_0.8.16-1_all.deb">https://dev.mysql.com/get/mysql-apt-config_0.8.16-1_all.deb</a></p><p>下载到本地后安装：</p><pre><code>dpkg -i mysql-apt-config_0.8.16-1_all.deb
</code></pre><p>期间会提示选择安装的 MySQL 版本，第一步选择当前安装的 MySQL 5.7，然后下一步选择 MySQL server 8.0，然后再下一步切换到 ok 选项确认。</p><p>配置完成后更新 apt 库及安装新版 MySQL：</p><pre><code>apt update
apt install mysql-server
</code></pre><p>安装完成后验证当前安装版本：</p><pre><code>mysql -V
</code></pre><p>以上就是简单的 MySQL 升级教程。</p><p>参考链接：<br><a href="https://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en/#apt-repo-setup">https://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en/#apt-repo-setup</a><br><a href="https://www.digitalocean.com/community/questions/upgrade-mysql-5-7-to-8-ubuntu-18-04">https://www.digitalocean.com/community/questions/upgrade-mysql-5-7-to-8-ubuntu-18-04</a></p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/1899.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/1899.html</wfw:commentRss>
</item>
<item>
<title>使用 dnsmasq 和 iptables 控制域名流量</title>
<link>https://blog.niekun.net/archives/1872.html</link>
<guid>https://blog.niekun.net/archives/1872.html</guid>
<pubDate>Mon, 26 Oct 2020 22:29:00 +0800</pubDate>
<dc:creator>admin</dc:creator>
<description><![CDATA[dnsmasq 是处理 dns 请求的工具，实现域名请求解析到目标 IP 地址的过程。可以方便的管理本机或局域网设备的域名解析服务，使用教程参考：https://blog.niekun.net/...]]></description>
<content:encoded xml:lang="zh-CN"><![CDATA[
<p>dnsmasq 是处理 dns 请求的工具，实现域名请求解析到目标 IP 地址的过程。可以方便的管理本机或局域网设备的域名解析服务，使用教程参考：<a href="https://blog.niekun.net/archives/1869.html">https://blog.niekun.net/archives/1869.html</a></p><p>iptables 是网络防火墙规则管理/修改工具，管理网络数据包的处理和转发。使用教程参考：<a href="https://blog.niekun.net/archives/1863.html">https://blog.niekun.net/archives/1863.html</a></p><p>iptables 管理某个源地址或目标地址的流量时，只能识别 IP 地址，比如：</p><pre><code># -s 匹配源地址流量,接收来自 192.168.1.230 发往本机的流量：
iptables -t filter -A INPUT -s 192.168.1.230 -j ACCEPT

# -d 匹配目标地址的流量,丢弃发往 192.168.1.123 的流量：
iptables -t filter -A OUTPUT -d 192.168.1.123 -j DROP</code></pre><!--more--><p><strong>如果要使用 iptables 管理某域名的流量，可以使用 dnsmasq-full 里的 ipset 工具标记并保存域名包含的 IP 地址池，然后在 iptables 中调取。</strong></p><p>使用命令查看当前安装版本的 dnsmasq 是否支持 ipset：</p><p>查询版本：</p><pre><code>dnsmasq -v
</code></pre><p>信息里 Compile time options 可以看到当前安装版本支持的选项功能 ，如：ipset</p><pre><code>root@OpenWrt:/etc# dnsmasq -v
Dnsmasq version 2.80  Copyright (c) 2000-2018 Simon Kelley
Compile time options: IPv6 GNU-getopt no-DBus no-i18n no-IDN DHCP DHCPv6 no-Lua TFTP conntrack ipset auth DNSSEC no-ID loop-detect inotify dumpfile
...</code></pre><p>如果没有 ipset 就需要手动安装 dnsmasq-full 版本了，升级方法参考：<a href="https://blog.niekun.net/archives/1869.html">https://blog.niekun.net/archives/1869.html</a></p><h3>域名解析标记</h3><p>首先建立我们自定义的 ipset 表来存储解析的 IP 地址：</p><pre><code>ipset create block hash:ip
</code></pre><p>可以查询当前这个列表是空的：</p><pre><code>root@OpenWrt:~# ipset list block
Name: block
Type: hash:ip
Revision: 4
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 88
References: 0
Number of entries: 0
Members:</code></pre><p>使用 dnsmasq 的 ipset 命令做域名解析结果标记和存储，在 dnsmasq 的配置文件，如：<code>/etc/dnsmasq.conf</code> 中加入如下语句：</p><pre><code>ipset=/360.com/block
</code></pre><p>重启 ndsmasq 服务：</p><pre><code>systemctl restart dnsmasq
</code></pre><p>使用 nslookup 命令对 360.com 域名进行 dns 查询：</p><pre><code>root@OpenWrt:/etc# nslookup 360.com
Server:        127.0.0.1
Address:    127.0.0.1#53

Name:      360.com
Address 1: 180.163.251.93
Address 2: 36.110.213.45</code></pre><p>这时候重新查看建立的 ipset 表内容：</p><pre><code>root@OpenWrt:/etc# ipset list block
Name: block
Type: hash:ip
Revision: 4
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 184
References: 0
Number of entries: 2
Members:
36.110.213.45
180.163.251.93</code></pre><p>可以看到域名对应的 IP 地址已经记录到了 block 表内。</p><h3>流量处理</h3><p>iptables 可以调用 ipset 表来对流量进行处理，使用 <code>-I</code> 参数将规则添加到链表最上方以确保顺利匹配，使用 <code>-m set --match-set 列表名 dst</code> 匹配目标地址，或 <code>-m set --match-set 列表名 src</code> 匹配原地址，下面举例说明：</p><pre><code># 屏蔽 block 表地址的访问
iptables -t filter -I INPUT -m set --match-set block src -j DROP

# 允许 allow 表地址的访问
iptables -t filter -I INPUT -m set --match-set allow src -j RETURN</code></pre><p>iptables 设置完成后就可以测试对应域名是否受防火墙规则控制了。</p><p>查询路由表加入的规则：</p><pre><code>iptables -t filter -L -n
</code></pre><p>如果要删除 INPUT 路由链第一条规则，使用命令：</p><pre><code>iptables -t filter -D INPUT 1
</code></pre><p>以上就是使用 dnsmasq 的 ipset 功能实现 iptables 对域名流量的控制。</p>
]]></content:encoded>
<slash:comments>0</slash:comments>
<comments>https://blog.niekun.net/archives/1872.html#comments</comments>
<wfw:commentRss>https://blog.niekun.net/feed/archives/1872.html</wfw:commentRss>
</item>
</channel>
</rss>