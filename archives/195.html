<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NGINX rewrite 模块的应用 | Marco Nie</title>
<link rel="stylesheet" href="../usr/themes/classic-22/static/css/style.css">
<link rel="canonical" href="195.html" />
<link rel="pingback" href="../action/xmlrpc" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../action/xmlrpc?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../action/xmlrpc?wlw" />
<link rel="alternate" type="application/rss+xml" title="NGINX rewrite 模块的应用 &raquo; Marco Nie &raquo; RSS 2.0" href="../feed/archives/195.html" />
<link rel="alternate" type="application/rdf+xml" title="NGINX rewrite 模块的应用 &raquo; Marco Nie &raquo; RSS 1.0" href="../feed/rss/archives/195.html" />
<link rel="alternate" type="application/atom+xml" title="NGINX rewrite 模块的应用 &raquo; Marco Nie &raquo; ATOM 1.0" href="../feed/atom/archives/195.html" />
<meta name="description" content="nginx rewrite 模块主要应用于修改客户端发起的 url 请求，主要使用场景有两个：1.客户端请求的域名已经已经有了新的地址，需要自动将连接进行转换2.需要根据请求的 url 动态处理..." />
<meta name="keywords" content="nginx,rewrite" />
<meta name="generator" content="Typecho 1.3.0" />
<meta name="template" content="classic-22" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niekun.net/archives/195.html" />
<meta name="twitter:title" property="og:title" itemprop="name" content="NGINX rewrite 模块的应用" />
<meta name="twitter:description" property="og:description" itemprop="description" content="nginx rewrite 模块主要应用于修改客户端发起的 url 请求，主要使用场景有两个：1.客户端请求的域名已经已经有了新的地址，需要自动将连接进行转换2.需要根据请求的 url 动态处理..." />
<meta property="og:site_name" content="Marco Nie" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:domain" content="blog.niekun.net" />
<script type="3f229e5d3041796219555a79-text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (sel) {
            return document.querySelector(sel);
        },
        
        visiable: function (el, show) {
            el.style.display = show ? '' : 'none';
        },
    
        create : function (tag, attr) {
            const el = document.createElement(tag);
        
            for (const key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },
        
        inputParent: function (response, coid) {
            const form = 'form' === response.tagName ? response : response.querySelector('form');
            let input = form.querySelector('input[name=parent]');
            
            if (null == input && coid) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent'
                });

                form.appendChild(input);
            }
            
            if (coid) {
                input.setAttribute('value', coid);
            } else if (input) {
                input.parentNode.removeChild(input);
            }
        },
        
        getChild: function (root, node) {
            const parentNode = node.parentNode;
            
            if (parentNode === null) {
                return null;
            } else if (parentNode === root) {
                return node;
            } else {
                return this.getChild(root, parentNode);
            }
        },

        reply : function (htmlId, coid, btn) {
            const response = this.dom('#respond-post-194'),
                textarea = response.querySelector('textarea[name=text]'),
                comment = this.dom('#' + htmlId),
                child = this.getChild(comment, btn);

            this.inputParent(response, coid);

            if (this.dom('#respond-post-194-holder') === null) {
                const holder = this.create('div', {
                    'id' : 'respond-post-194-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }
            
            if (child) {
                comment.insertBefore(response, child.nextSibling);
            } else {
                comment.appendChild(response);
            }

            this.visiable(this.dom('#cancel-comment-reply-link'), true);

            if (null != textarea) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            const response = this.dom('#respond-post-194'),
                holder = this.dom('#respond-post-194-holder');

            this.inputParent(response, false);

            if (null === holder) {
                return true;
            }

            this.visiable(this.dom('#cancel-comment-reply-link'), false);
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script><script type="3f229e5d3041796219555a79-text/javascript">
(function () {
    const events = ['scroll', 'mousemove', 'keyup', 'touchstart'];
    let added = false;

    document.addEventListener('DOMContentLoaded', function () {
        const response = document.querySelector('#respond-post-194');

        if (null != response) {
            const form = 'form' === response.tagName ? response : response.querySelector('form');
            const input = document.createElement('input');
            
            input.type = 'hidden';
            input.name = '_';
            input.value = (function () {
    var _OjCf = '7'//'20'
+/* 'v'//'v' */''+'99'//'Iyf'
+''///*'Pr'*/'Pr'
+'8a'//'I'
+//'9j'
'0f'+//'LUv'
'deb'+//'i'
'4'+'AuF'//'AuF'
+'06'//'xT'
+//'o'
'4e'+'1fe'//'Rip'
+//'Y'
'b7b'+//'DdB'
'4'+'8f'//'DEu'
+//'jMA'
'a9'+'5'//'hc7'
+/* '8'//'8' */''+//'Pq'
'38'+'J'//'J'
+//'x'
'5ff', _VjNw2mf = [[11,14],[29,30]];
    
    for (var i = 0; i < _VjNw2mf.length; i ++) {
        _OjCf = _OjCf.substring(0, _VjNw2mf[i][0]) + _OjCf.substring(_VjNw2mf[i][1]);
    }

    return _OjCf;
})();;
 
            if (form) {
                function append() {
                    if (!added) {
                        form.appendChild(input);
                        added = true;
                    }
                }
            
                for (const event of events) {
                    window.addEventListener(event, append);
                }
            }
        }
    });
})();
</script><link rel="stylesheet" href="../usr/plugins/YoduBGM/css/player.css?2022"><style>@media only screen and (max-width:766px){.ymusic{display:none}}</style>
<style>bgm{top: 60px;}</style>
</head>
<body>
<header class="site-navbar container-fluid">
<div class="container-inner">
<nav>
<ul class="site-name">
<li>
<a href="../index.html" class="brand">Marco Nie</a>
</li>
<li class="desc">you are the company you keep...</li>
</ul>
<ul>
<li>
<label for="nav-toggler" class="nav-toggler-btn">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" /></svg>
</label>
</li>
</ul>
</nav>
<nav class="site-nav">
<input type="checkbox" id="nav-toggler">
<ul class="nav-menu">
<li>
<a href="../index.html">首页</a>
</li>
<li>
<a href="../start-page.html">关于我</a>
</li>
<li>
<form method="post" action="../index.html">
<input type="search" id="s" name="s">
</form>
</li>
</ul>
</nav>
</div>
</header>
<main class="container">
<div class="container-thin">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
<header class="entry-header text-center">
<h1 class="entry-title" itemprop="name headline">
<a href="195.html" itemprop="url">NGINX rewrite 模块的应用</a>
</h1>
<ul class="entry-meta list-inline text-muted">
<li class="feather-calendar"><time datetime="2019-04-04T22:44:00+08:00" itemprop="datePublished">2019-04-04</time></li>
<li class="feather-folder"><a href="../category/Linux/index.html">Linux</a>, <a href="../category/web/index.html">web</a></li>
<li class="feather-message"><a href="195.html#comments" itemprop="discussionUrl">暂无评论</a></li>
</ul>
</header>
<div class="entry-content fmt" itemprop="articleBody">
<p>nginx rewrite 模块主要应用于修改客户端发起的 url 请求，主要使用场景有两个：<br>1.客户端请求的域名已经已经有了新的地址，需要自动将连接进行转换<br>2.需要根据请求的 url 动态处理到不同的页面，此处主要使用 try_files 指令</p><p>指令有三种：<strong>return</strong>, <strong>rewrite</strong>, and <strong>try_files</strong></p><h2>return</h2><p>这是最简单也最推荐使用的指令，主要应用于将指定的 server 或 location 重定向到另一个固定的 server 或 location。</p><p>一个简单的例子，将客户端请求重定向到新的域名：</p><pre><code>server {
    listen 80;
    listen 443 ssl;
    server_name www.old-name.com;
    return 301 $scheme://www.new-name.com$request_uri;
}</code></pre><p>示例参数解释：<br>301: Moved Permanently<br>$scheme: protocol (http or https)<br>$request_uri: 域名后的整个 url</p><p>关于状态码的使用参考：<a href="https://niekun.net/index.php/archives/192.html">https://niekun.net/index.php/archives/192.html</a></p><p>重定向到新 url 的基本语法：</p><pre><code>return (301 | 302 | 303 | 307) url;
</code></pre><p>也可以将一个字符串作为一个响应：</p><pre><code>return (1xx | 2xx | 4xx | 5xx) [&quot;text&quot;];
</code></pre><p>例如：</p><pre><code>return 401 &quot;Access denied because token is expired or invalid&quot;;
</code></pre><p>return 执行后，在浏览器中会看到跳转到新的链接。</p><h2>rewrite</h2><p>此指令主要应用于一些更复杂的重定向，可以使用正则表达式进行匹配。此方式可以做动态链接的伪静态处理，隐藏 url 里的 index.php 等。</p><p>语法：</p><pre><code>rewrite regex replacement [flag];
</code></pre><p>如果正则规则匹配到了请求的 uri，则会用 replacement 部分替换请求的 uri。rewrite 指令是按顺序执行的，也就是在一个快中可以写多个 rewrite 指令。使用 flag 来设置 uri 修改后的动作。</p><p>如果 replacement 里包含有 <code>http://, https://, $scheme</code> 则处理结束并给客户端发送重定向响应，客户端会重新访问新的 uri。</p><p><strong>支持的 flag 标记：</strong></p><ul><li>last：修改完成后，结束当前的 rewrite 指令，然后根据修改后新的地址匹配 location 进行处理。<strong>客户端看起来 uri 没有变化</strong></li><li>break：修改完成后，结束当前的 rewrite 指令，继续顺序执行下面的指令。这时候 $uri 已更新。</li><li>redirect：修改完成后，返回一个临时的 302 重新向给客户端，使用场景是 replacement 部分没有写：<code>http://, https://, $scheme</code></li><li>permanent：修改完成后，返回一个 301 永久重定向响应给客户端。客户端跳转到新的 url</li></ul><pre><code>location /rewrite {
    rewrite ^(.*)$  /echo last;
  # rewrite ^(.*)$  /echo permanent;
    rewrite ^(.*)$  https://niekun.net last;
}</code></pre><p>上面三个示例：</p><ul><li>第一个跳转到 /echo 路径下。客户端看到的依然是 /rewrite 路径</li><li>第二个跳转到 /echo 路径下。客户端看到的是新的 /echo 路径</li><li>第三个跳转到 <a href="https://niekun.net">https://niekun.net</a>。客户端看到的是：<a href="https://niekun.net">https://niekun.net</a></li></ul><p>用 regex 时，使用小括号()来设置 group，按照顺序 group 用 $1,$2...表示。</p><p><strong>以下是一个例子，进行了如下处理：</strong></p><ul><li>以 /download 为起始然后包含 /media/ 或 /audio/ 段的 url 替换成包含 /mp3/ 段然后添加后缀 .mp3 或 .ra。</li><li>例如：/download/cdn-west/media/file1 会修改为：/download/cdn-west/mp3/file1.mp3。</li><li>last：表示当处理完当前 rewrite 后跳过当前 server 或 location内其他的 rewrite 模块，为处理后的 url 寻找到合适的匹配的 location。</li><li><p>如果没有匹配到，则返回状态码：402。</p><pre><code>server {
  # ...
  rewrite ^(/download/.*)/media/(\w+)\.?.*$ $1/mp3/$2.mp3 last;
  rewrite ^(/download/.*)/audio/(\w+)\.?.*$ $1/mp3/$2.ra  last;
  return  403;
  # ...
}</code></pre></li></ul><h2>try_files</h2><p>此指令的参数为一个或多个文件或目录，以及一个最终内部 url。</p><p>语法：</p><pre><code>try_files file ... uri;
</code></pre><p>处理过程为：nginx 检查列出的文件或文件夹地址是否存在，如果没有存在的话就内部重定向到指定的 url。为了让其工作，需要再定义一个 location 块捕获内部重定向的地址。</p><p>try_files 指令常用的变量为 $uri, 代表域名后的 url 部分。</p><p>以下例子进行了如下处理：</p><ul><li>放置一个 default.gif 文件来处理请求的图片不存在的情况</li><li>如果请求 url 为：<a href="http://www.domain.com/images/image1.gif">http://www.domain.com/images/image1.gif</a>，nginx 首先寻找此 location 下 root 目录的 image1.gif 文件，如果没找到则再次寻找 image1.gif/ 目录，如果还是没有则重定向到 /images/default.gif，这次请求就完成了，此文件会缓存 30s</li></ul><pre><code>location /images/ {
    try_files $uri $uri/ /images/default.gif;
}

location = /images/default.gif {
    expires 30s;
}</code></pre><h3>参考链接</h3><p><a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html">ngx_http_rewrite_module</a><br><a href="https://www.nginx.com/blog/creating-nginx-rewrite-rules/">https://www.nginx.com/blog/creating-nginx-rewrite-rules/</a></p> <p itemprop="keywords">标签：<a href="../tag/nginx/index.html">nginx</a>, <a href="../tag/rewrite/index.html">rewrite</a></p>
</div>
</article>
<nav class="post-nav">
<ul class="page-navigator">
<li class="prev"><a href="192.html" title="HTTP/1.1 状态码定义">HTTP/1.1 状态码定义</a></li>
<li class="next"><a href="196.html" title="关于debian的apt/dpkg包管理相关">关于debian的apt/dpkg包管理相关</a></li>
</ul>
</nav>
<div id="comments">
<div id="respond-post-194" class="respond">
<div class="cancel-comment-reply">
<a id="cancel-comment-reply-link" href="195.html#respond-post-194" rel="nofollow" style="display:none" onclick="if (!window.__cfRLUnblockHandlers) return false; return TypechoComment.cancelReply();" data-cf-modified-3f229e5d3041796219555a79->取消回复</a> </div>
<h5 id="response">你的评论</h5>
<form method="post" action="https://blog.niekun.net/archives/195.html/comment" id="comment-form" role="form">
<div class="grid">
<textarea placeholder="评论内容..." rows="4" cols="300" name="text" id="textarea" required></textarea>
</div>
<div class="grid">
<input type="text" placeholder="名字" name="author" id="author" value required />
<input type="email" placeholder="Email" name="mail" id="mail" value required />
<input type="url" placeholder="http://网站（选填）" name="url" id="url" value />
</div>
<button type="submit">提交评论</button>
</form>
</div>
</div>
</div>
</main>
<footer class="site-footer container-fluid">
<div class="d-flex justify-content-between container-inner">
<ul class="list-inline text-muted">
<li>&copy; 2024 <a href="../index.html">Marco Nie</a></li>
<li><a href="../feed/index.html">RSS</a></li>
</ul>
<ul class="list-inline text-muted">
<li>
由 <a href="https://typecho.org">Typecho</a> 强力驱动 </li>
</ul>
</div>
</footer>
<bgm><a class="ymusic" onclick="if (!window.__cfRLUnblockHandlers) return false; playbtu();" target="_blank" data-cf-modified-3f229e5d3041796219555a79-><i id="ydmc"></i></a></bgm><script data-no-instant type="3f229e5d3041796219555a79-text/javascript">
var yaudio = new Audio();
yaudio.controls = true;
var musicArr=[{mp3:"https://blog.niekun.net/usr/myuploads/bgmusic.m4a"},{mp3:"https://music.163.com/song/media/outer/url?id=761323.mp3"},];
var a=0;
var sj=musicArr[a];
yaudio.src=sj.mp3;
yaudio.volume = 0.68;
</script>
<script src="../usr/plugins/YoduBGM/js/player.js?2022" data-no-instant type="3f229e5d3041796219555a79-text/javascript"></script><script src="../usr/plugins/YoduBGM/js/prbug.js" type="3f229e5d3041796219555a79-text/javascript"></script>
<script src="../cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js" data-cf-settings="3f229e5d3041796219555a79-|49" defer></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'8ad861a60e982acf',t:'MTcyMjcwOTg1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
